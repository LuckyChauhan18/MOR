name: Production CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  agent-check:
    name: Agent Service Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'blog_agent_service/requirements.txt'

      - name: Install Agent Dependencies
        working-directory: ./blog_agent_service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Agent Verification
        working-directory: ./blog_agent_service
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          AGENT_SECRET_KEY: ${{ secrets.AGENT_SECRET_KEY }}
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          python ../tests/agent/verify_modular_agent.py

  backend-check:
    name: Backend Service Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './blog_web_app/backend/package-lock.json'

      - name: Install Backend Dependencies
        working-directory: ./blog_web_app/backend
        run: npm install

  docker-validate:
    name: Docker Environment Check
    needs: [agent-check, backend-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Mock Env Files
        run: |
          touch ./blog_web_app/backend/.env
          touch ./blog_web_app/frontend/.env
          touch ./blog_agent_service/.env

      - name: Validate Docker Compose Config
        run: docker compose -f ./blog_web_app/docker-compose.yml config

  deploy-to-prod:
    name: Production Deployment
    needs: docker-validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Validate Deployment Secrets
        run: |
          if [ -z "${{ secrets.AWS_HOST || vars.AWS_HOST }}" ]; then
            echo "Error: AWS_HOST is missing. Please check your GitHub Secrets/Variables."
            exit 1
          fi
          if [ -z "${{ secrets.AWS_USER || vars.AWS_USER }}" ]; then
            echo "Error: AWS_USER is missing. Please check your GitHub Secrets/Variables."
            exit 1
          fi
          echo "Deployment secrets validated."

      - name: Execute SSH Deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          PROD_ENV_BACKEND: ${{ secrets.PROD_ENV_BACKEND || vars.PROD_ENV_BACKEND }}
          PROD_ENV_FRONTEND: ${{ secrets.PROD_ENV_FRONTEND || vars.PROD_ENV_FRONTEND }}
          PROD_ENV_AGENT: ${{ secrets.PROD_ENV_AGENT || vars.PROD_ENV_AGENT }}
        with:
          host: ${{ secrets.AWS_HOST || vars.AWS_HOST }}
          username: ${{ secrets.AWS_USER || vars.AWS_USER }}
          key: ${{ secrets.AWS_SSH_KEY || vars.AWS_SSH_KEY }}
          envs: PROD_ENV_BACKEND,PROD_ENV_FRONTEND,PROD_ENV_AGENT
          command_timeout: 30m
          script: |
            set -e
            
            echo "Checking if repository exists..."
            if [ ! -d "$HOME/MOR" ]; then
              echo "Repository not found. Cloning..."
              git clone https://github.com/LuckyChauhan18/MOR.git "$HOME/MOR"
            fi
            
            cd "$HOME/MOR/blog_web_app"
            
            echo "Ensuring Modern Docker Compose (V2)..."
            if ! docker compose version >/dev/null 2>&1; then
              echo "Docker Compose V2 not found. Installing..."
              sudo apt-get update
              sudo apt-get install -y docker-compose-v2
            fi
            
            echo "Pulling latest code..."
            git pull origin main
            
            echo "Writing .env files..."
            printf "%s" "$PROD_ENV_BACKEND" > backend/.env
            printf "%s" "$PROD_ENV_FRONTEND" > frontend/.env
            printf "%s" "$PROD_ENV_AGENT" > ../blog_agent_service/.env
            
            echo "Rebuilding and restarting containers..."
            sudo docker compose up -d --build
            
            echo "Deployment successful."
